{% extends "base.html" %}
{% block content %}
<section class="panel">
  <h2>LiteLLM Models</h2>
  {% if litellm_error %}
  <p class="muted">{{ litellm_error }}</p>
  {% else %}
  <p class="muted">Fetched at {{ fetched_at or "Unknown" }}</p>
  {% if litellm_models %}
  <ul class="model-cards">
    {% for model in litellm_models %}
    {% set mappable = model.litellm_mappable %}
    <li class="model-card">
      <div class="model-card__header">
        <div>{{ model.id }}</div>
        <div class="model-card__meta">
          {% if model.mode %}
          <span class="badge">Mode: {{ model.mode }}</span>
          {% endif %}
          {% if model.model_type %}
          <span class="badge">Type: {{ model.model_type }}</span>
          {% endif %}
          {% if model.context_window %}
          <span class="badge">Ctx: {{ "{:,}".format(model.context_window) }} tokens</span>
          {% endif %}
          {% if model.max_output_tokens %}
          <span class="badge">Max output: {{ "{:,}".format(model.max_output_tokens) }} tokens</span>
          {% endif %}
          {% if model.capabilities %}
          <span class="badge">Capabilities: {{ model.capabilities | join(", ") }}</span>
          {% endif %}
        </div>
      </div>
      <div class="model-card__body">
        {%- set summary_items = [] -%}
        {%- if model.model_type -%}
          {%- set _ = summary_items.append("Tipo: " ~ model.model_type) -%}
        {%- endif -%}
        {%- if model.mode -%}
          {%- set _ = summary_items.append("Modo: " ~ model.mode) -%}
        {%- endif -%}
        {%- if model.context_window -%}
          {%- set _ = summary_items.append("Contexto: " ~ "{:,}".format(model.context_window) ~ " tokens") -%}
        {%- endif -%}
        {%- if model.capabilities -%}
          {%- set _ = summary_items.append("Capacidades: " ~ (model.capabilities | join(", "))) -%}
        {%- endif -%}
        {%- set pricing_items = [] -%}
        {%- if mappable.get("input_cost_per_token") -%}
          {%- set _ = pricing_items.append("Input: $" ~ "{:.4f}".format(mappable["input_cost_per_token"] * 1000) ~ "/1K") -%}
        {%- endif -%}
        {%- if mappable.get("output_cost_per_token") -%}
          {%- set _ = pricing_items.append("Output: $" ~ "{:.4f}".format(mappable["output_cost_per_token"] * 1000) ~ "/1K") -%}
        {%- endif -%}
        {%- if mappable.get("input_cost_per_second") -%}
          {%- set _ = pricing_items.append("Audio: $" ~ "{:.4f}".format(mappable["input_cost_per_second"] * 60) ~ "/min") -%}
        {%- endif -%}
        {%- if mappable.get("output_cost_per_image") -%}
          {%- set _ = pricing_items.append("Image: $" ~ "{:.2f}".format(mappable["output_cost_per_image"])) -%}
        {%- endif -%}
        {%- if pricing_items -%}
          {%- set _ = summary_items.append("Precios (ref. OpenAI): " ~ (pricing_items | join(", "))) -%}
        {%- endif -%}
        {%- if summary_items -%}
          {{- summary_items | join(" · ") -}}
        {%- else -%}
          <span class="muted">Sin información resumida disponible.</span>
        {%- endif -%}
      </div>
      <div class="model-card__actions">
        <button type="button" class="model-details-toggle" data-model-index="{{ loop.index0 }}">
          Ver detalles
        </button>
      </div>
      <details class="model-card__details" hidden>
        <summary>Detalles extendidos</summary>
        <div>
          <p class="muted">Parámetros mapeables a LiteLLM:</p>
          <pre class="model-card__body">{{ mappable | tojson(indent=2) }}</pre>
          <p class="muted">Respuesta completa del endpoint:</p>
          <pre class="model-card__body">{{ model.raw | tojson(indent=2) }}</pre>
        </div>
      </details>
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p>No models were returned by the LiteLLM endpoint.</p>
  {% endif %}
  {% endif %}
</section>
<script>
  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.model-details-toggle').forEach((button) => {
      button.addEventListener('click', () => {
        const card = button.closest('.model-card');
        const details = card.querySelector('.model-card__details');
        if (!details) return;

        const isHidden = details.hasAttribute('hidden');
        if (isHidden) {
          details.removeAttribute('hidden');
          details.open = true;
          button.textContent = 'Ocultar detalles';
        } else {
          details.setAttribute('hidden', '');
          details.open = false;
          button.textContent = 'Ver detalles';
        }
      });
    });
  });
</script>
{% endblock %}
