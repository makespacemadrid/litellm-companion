{% extends "base.html" %}
{% block content %}
<section class="panel">
  <h2>LiteLLM Models</h2>
  {% if litellm_error %}
  <p class="muted">{{ litellm_error }}</p>
  {% else %}
  <p class="muted">Fetched at {{ fetched_at or "Unknown" }}</p>
  {% if litellm_models %}
  <ul class="model-cards">
    {% for model in litellm_models %}
    {% set mappable = model.litellm_fields %}
    <li class="model-card">
      <div class="model-card__header">
        <div class="model-card__title">{{ model.id }}</div>
        {% if model.raw.get('details') %}
        {% set details = model.raw.details %}
        <div class="model-card__subtitle">
          {% if details.get('family') %}{{ details.family }}{% endif %}
          {% if details.get('parameter_size') %}
            {% if details.get('family') %} • {% endif %}{{ details.parameter_size }}
          {% endif %}
          {% if details.get('quantization_level') %}
            {% if details.get('family') or details.get('parameter_size') %} • {% endif %}{{ details.quantization_level }}
          {% endif %}
        </div>
        {% endif %}
        <div class="model-card__meta">
          {% if model.litellm_mode %}
          <span class="badge badge-mode">{{ model.litellm_mode }}</span>
          {% endif %}
          {% if model.model_type %}
          <span class="badge badge-type">{{ model.model_type }}</span>
          {% endif %}
          {% if mappable.get('litellm_provider') %}
          <span class="badge badge-provider">{{ mappable.litellm_provider }}</span>
          {% endif %}
        </div>
      </div>

      <!-- Capabilities Section -->
      {% if model.capabilities %}
      <div class="metadata-section metadata-section--capabilities">
        <div class="metadata-section__title">Capacidades</div>
        <div class="capabilities-grid">
          {% for capability in model.capabilities %}
          <div class="capability-item">{{ capability }}</div>
          {% endfor %}
        </div>
      </div>
      {% endif %}

      <!-- Token Limits Section -->
      <div class="metadata-section metadata-section--tokens">
        <div class="metadata-section__title">Límites de Tokens</div>
        <div class="token-limits">
          {% if model.max_input_tokens or model.context_window %}
          <div class="token-limit-item">
            <span class="token-limit-item__label">Entrada (Context):</span>
            <span class="token-limit-item__value">{{ "{:,}".format(model.max_input_tokens or model.context_window) }}</span>
          </div>
          {% endif %}
          {% if model.max_output_tokens %}
          <div class="token-limit-item">
            <span class="token-limit-item__label">Salida:</span>
            <span class="token-limit-item__value">{{ "{:,}".format(model.max_output_tokens) }}</span>
          </div>
          {% endif %}
        </div>
      </div>

      <div class="model-card__actions">
        <button type="button" class="toggle-details" data-index="{{ loop.index0 }}">
          Ver más información
        </button>
      </div>
      <details class="model-card__details">
        <summary style="display: none;"></summary>
        <div class="model-card__details-content">
          <div class="litellm-fields-preview">
            <p class="muted">Parámetros mapeables a la definición de LiteLLM:</p>
            {% if mappable %}
            <pre class="model-card__body" data-type="mappable"></pre>
            {% else %}
            <p class="muted">No se encontraron parámetros específicos de LiteLLM en la respuesta.</p>
            {% endif %}
          </div>
          <details class="raw-data-toggle">
            <summary>Ver datos completos (JSON)</summary>
            <pre class="raw-data-json" data-type="raw"></pre>
          </details>
        </div>
      </details>
    </li>
    {% endfor %}
  </ul>
  {% else %}
  <p>No models were returned by the LiteLLM endpoint.</p>
  {% endif %}
  {% endif %}
</section>
<script>
  // Store model data for display
  const modelData = [
    {% for model in litellm_models %}
    {
      mappable: {{ model.litellm_fields | tojson | safe }},
      raw: {{ model.raw | tojson | safe }}
    }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];

  // Clean JSON by removing null, empty strings, and empty objects/arrays
  function cleanJSON(obj) {
    if (obj === null || obj === undefined) return null;
    if (typeof obj !== 'object') return obj;

    if (Array.isArray(obj)) {
      const cleaned = obj.map(cleanJSON).filter(item => item !== null);
      return cleaned.length > 0 ? cleaned : null;
    }

    const cleaned = {};
    for (const [key, value] of Object.entries(obj)) {
      const cleanedValue = cleanJSON(value);
      if (cleanedValue !== null && cleanedValue !== '' &&
          !(Array.isArray(cleanedValue) && cleanedValue.length === 0) &&
          !(typeof cleanedValue === 'object' && Object.keys(cleanedValue).length === 0)) {
        cleaned[key] = cleanedValue;
      }
    }

    return Object.keys(cleaned).length > 0 ? cleaned : null;
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.toggle-details').forEach((button) => {
      button.addEventListener('click', () => {
        const index = parseInt(button.dataset.index);
        const card = button.closest('.model-card');
        const details = card.querySelector('.model-card__details');
        const mappablePre = card.querySelector('pre[data-type="mappable"]');
        const rawPre = card.querySelector('.raw-data-json');

        // Toggle details
        const isOpen = details.open;
        if (!isOpen) {
          // Populate with cleaned JSON when opening
          if (mappablePre && modelData[index]) {
            const cleanedMappable = cleanJSON(modelData[index].mappable);
            mappablePre.textContent = JSON.stringify(cleanedMappable, null, 2);
          }
          if (rawPre && modelData[index]) {
            const cleanedRaw = cleanJSON(modelData[index].raw);
            rawPre.textContent = JSON.stringify(cleanedRaw, null, 2);
          }
          details.open = true;
          button.textContent = 'Ocultar información';
        } else {
          details.open = false;
          button.textContent = 'Ver más información';
        }
      });
    });
  });
</script>
{% endblock %}
