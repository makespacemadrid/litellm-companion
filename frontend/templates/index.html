{% extends "base.html" %}
{% block content %}
<section class="panel" style="display: grid; gap: 1rem;">
  <div style="display: grid; gap: 1rem; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
    <div class="stat-card">
      <div class="stat-label">Providers</div>
      <div class="stat-value">{{ stats.providers }}</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Models</div>
      <div class="stat-value">{{ stats.models }}</div>
    </div>
    <div class="stat-card warning">
      <div class="stat-label">Orphaned</div>
      <div class="stat-value">{{ stats.orphaned }}</div>
    </div>
    <div class="stat-card info">
      <div class="stat-label">Modified</div>
      <div class="stat-value">{{ stats.modified }}</div>
    </div>
    <div class="stat-card success">
      <div class="stat-label">LiteLLM Models</div>
      <div class="stat-value">{{ stats.litellm_models }}</div>
    </div>
  </div>

  {% if stats.categories %}
  <div class="categories-panel">
    <h3 style="margin: 0 0 1rem 0;">Model Categories</h3>
    <div class="categories-grid">
      {% set category_icons = {
        'chat': 'ðŸ’¬',
        'vision': 'ðŸ‘ï¸',
        'code': 'ðŸ’»',
        'reasoning': 'ðŸ§ ',
        'embedding': 'ðŸ”¢',
        'audio': 'ðŸŽ¤',
        'image': 'ðŸŽ¨',
        'unknown': 'â“'
      } %}
      {% for cat, count in stats.categories.items() %}
        {% if count > 0 %}
        <div class="category-badge" onclick="window.location.href='/models?category={{ cat }}'">
          <span class="category-icon">{{ category_icons.get(cat, 'ðŸ“¦') }}</span>
          <span class="category-name">{{ cat.capitalize() }}</span>
          <span class="category-count">{{ count }}</span>
        </div>
        {% endif %}
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <div class="status-grid">
    <div>
      <h3>LiteLLM Destination</h3>
      {% if config.litellm.configured %}
      <p><strong>{{ config.litellm.base_url }}</strong></p>
      {% else %}
      <p class="muted">Not configured. Set it in Admin to enable sync.</p>
      {% endif %}
    </div>
    <div>
      <h3>Sync</h3>
      {% if config.sync_interval_seconds > 0 %}
      <p>Every {{ config.sync_interval_seconds }} seconds</p>
      {% else %}
      <p class="muted">Automatic sync disabled</p>
      {% endif %}
      {% if last_sync %}
      <div class="last-sync-info">
        <p class="muted" style="margin-bottom: 0.5rem;">
          Last synced: {{ last_sync.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
        </p>
        <div class="sync-stats">
          <span class="sync-stat-badge success">
            +{{ last_sync.results.total_models_fetched }} models
          </span>
          {% if last_sync.results.errors|length > 0 %}
          <span class="sync-stat-badge error">
            {{ last_sync.results.errors|length }} errors
          </span>
          {% else %}
          <span class="sync-stat-badge success">
            âœ“ OK
          </span>
          {% endif %}
        </div>
      </div>
      {% else %}
      <p class="muted">No sync completed yet</p>
      {% endif %}
    </div>
    <div>
      <h3>Actions</h3>
      <form id="sync-form" action="/sync" method="post">
        <button type="submit" class="btn-primary">Run sync now</button>
      </form>
    </div>
  </div>
</section>

<!-- Sync Progress Modal -->
<div id="sync-modal" class="sync-modal">
  <div class="sync-modal-content">
    <div class="sync-modal-header">
      <h2>Synchronization Progress</h2>
    </div>
    <div class="sync-modal-body" id="sync-modal-body">
      <div class="sync-progress">
        <div class="sync-spinner"></div>
        <p>Synchronizing providers...</p>
      </div>
    </div>
    <div class="sync-modal-footer" id="sync-modal-footer" style="display: none;">
      <button class="btn-primary" onclick="closeSyncModal()">Close</button>
      <button class="btn-secondary" onclick="window.location.reload()">Reload Page</button>
    </div>
  </div>
</div>

<section class="panel">
  <h2>Providers</h2>
  {% if config.sources %}
  <div class="provider-grid">
    {% for source in config.sources %}
    <div class="provider-card">
      <div class="provider-name">{{ source.name }}</div>
      <div class="muted">{{ human_source_type(source.type) }} @ {{ source.base_url }}</div>
      <div class="provider-stats-mini">
        <span class="badge">Models: {{ source.stats.total }}</span>
        <span class="badge muted">Orphaned: {{ source.stats.orphaned }}</span>
        <span class="badge muted">Modified: {{ source.stats.modified }}</span>
      </div>
      {% if source.last_sync_status %}
        {% if source.last_sync_status == 'error' %}
          <div class="badge error" title="{{ source.last_sync_error }}">Last sync: Error</div>
        {% else %}
          <div class="badge success">Last sync: OK</div>
        {% endif %}
      {% endif %}
      {% if source.prefix %}<div class="badge">Prefix: {{ source.prefix }}</div>{% endif %}
      {% if source.tags and source.tags|length %}
        <div class="tag-row">
          {% for tag in source.tags[:4] %}
            <span class="badge">#{{ tag }}</span>
          {% endfor %}
          {% if source.tags|length > 4 %}
            <span class="badge muted">+{{ source.tags|length - 4 }}</span>
          {% endif %}
        </div>
      {% endif %}
    </div>
    {% endfor %}
  </div>
  {% else %}
  <p>No providers configured. Add them in Admin.</p>
  {% endif %}
</section>

<style>
.stat-card {
  padding: 1rem;
  border-radius: 8px;
  background: #242424;
  border: 1px solid #333;
}
.stat-card .stat-label { font-size: 0.9rem; color: #aaa; }
.stat-card .stat-value { font-size: 2rem; font-weight: 700; color: #fff; }
.stat-card.warning { background: #2a1a1a; border-color: #ff6b6b; }
.stat-card.info { background: #1a2432; border-color: #4a9eff; }
.stat-card.success { background: #102a1a; border-color: #10b981; }
.categories-panel {
  background: #242424;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 1.5rem;
}
.categories-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 0.75rem;
}
.category-badge {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem;
  background: #1a1a1a;
  border: 1px solid #333;
  border-radius: 8px;
  transition: all 0.2s;
  cursor: pointer;
}
.category-badge:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(74, 158, 255, 0.2);
  border-color: #4a9eff;
  background: #2a2a2a;
}
.category-icon {
  font-size: 1.5rem;
}
.category-name {
  flex: 1;
  font-size: 0.9rem;
  font-weight: 500;
  color: #aaa;
}
.category-count {
  font-size: 1.25rem;
  font-weight: 700;
  color: #4a9eff;
}
.status-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 1rem;
  padding-top: 0.5rem;
}
.provider-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: 1rem;
}
.provider-card {
  border: 1px solid #333;
  border-radius: 8px;
  padding: 0.75rem;
  background: #242424;
}
.provider-name { font-weight: 700; margin-bottom: 0.25rem; color: #fff; }
.provider-stats-mini {
  display: flex;
  flex-wrap: wrap;
  gap: 0.35rem;
  margin: 0.5rem 0;
}
.badge {
  display: inline-block;
  padding: 0.2rem 0.5rem;
  background: #2a2a44;
  border-radius: 12px;
  font-size: 0.8rem;
  margin-right: 0.25rem;
  color: #a5b4fc;
}
.badge.muted { background: #2a2a2a; color: #888; }
.badge.success { background: #102a1a; color: #6ee7b7; }
.badge.error { background: #2a1a1a; color: #fca5a5; }
.tag-row { margin-top: 0.35rem; }
.btn-primary {
  background: #4a9eff;
  color: white;
  padding: 0.6rem 1.2rem;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-primary:hover {
  background: #3a8eef;
  transform: translateY(-1px);
}
.btn-secondary {
  background: #3a3a3a;
  color: white;
  padding: 0.6rem 1.2rem;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s;
}
.btn-secondary:hover {
  background: #4a4a4a;
  transform: translateY(-1px);
}

/* Sync Info Styles */
.last-sync-info {
  margin-top: 0.5rem;
}

.sync-stats {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.sync-stat-badge {
  display: inline-block;
  padding: 0.3rem 0.7rem;
  border-radius: 12px;
  font-size: 0.85rem;
  font-weight: 500;
}

.sync-stat-badge.success {
  background: #102a1a;
  color: #6ee7b7;
  border: 1px solid #1a4428;
}

.sync-stat-badge.error {
  background: #2a1a1a;
  color: #fca5a5;
  border: 1px solid #441a1a;
}

/* Sync Modal Styles */
.sync-modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.7);
}

.sync-modal-content {
  background-color: #1a1a1a;
  margin: 5% auto;
  border-radius: 12px;
  width: 90%;
  max-width: 700px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
  border: 1px solid #333;
}

.sync-modal-header {
  padding: 1.5rem;
  border-bottom: 1px solid #2a2a2a;
}

.sync-modal-header h2 {
  margin: 0;
  color: #4a9eff;
}

.sync-modal-body {
  padding: 2rem;
  max-height: 60vh;
  overflow-y: auto;
}

.sync-modal-footer {
  padding: 1rem 1.5rem;
  border-top: 1px solid #2a2a2a;
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
}

.sync-progress {
  text-align: center;
  padding: 2rem;
}

.sync-spinner {
  border: 4px solid #2a2a2a;
  border-top: 4px solid #4a9eff;
  border-radius: 50%;
  width: 50px;
  height: 50px;
  animation: spin 1s linear infinite;
  margin: 0 auto 1rem;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.sync-results {
  text-align: left;
}

.sync-summary {
  background: #1a2432;
  border: 1px solid #2a3a52;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1.5rem;
}

.sync-summary h3 {
  margin: 0 0 0.5rem 0;
  color: #4a9eff;
}

.sync-stat {
  display: flex;
  justify-content: space-between;
  margin: 0.5rem 0;
}

.sync-stat-label {
  font-weight: 500;
  color: #aaa;
}

.sync-stat-value {
  font-weight: 700;
  color: #4a9eff;
}

.provider-results {
  margin-top: 1rem;
}

.provider-result {
  background: #242424;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 1rem;
  margin-bottom: 1rem;
}

.provider-result.error {
  background: #2a1a1a;
  border-color: #441a1a;
}

.provider-result h4 {
  margin: 0 0 0.75rem 0;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: #fff;
}

.provider-result.success h4::before {
  content: 'âœ“';
  color: #10b981;
  font-size: 1.2rem;
}

.provider-result.error h4::before {
  content: 'âœ—';
  color: #ff6b6b;
  font-size: 1.2rem;
}

.provider-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 0.75rem;
  margin-top: 0.5rem;
}

.provider-stat {
  background: #1a1a1a;
  padding: 0.5rem;
  border-radius: 4px;
  border: 1px solid #2a2a2a;
}

.provider-stat-label {
  font-size: 0.85rem;
  color: #aaa;
}

.provider-stat-value {
  font-size: 1.1rem;
  font-weight: 700;
  color: #fff;
}

.error-message {
  color: #fca5a5;
  margin-top: 0.5rem;
  font-size: 0.9rem;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const syncForm = document.getElementById('sync-form');
  const syncModal = document.getElementById('sync-modal');
  const syncModalBody = document.getElementById('sync-modal-body');
  const syncModalFooter = document.getElementById('sync-modal-footer');

  if (syncForm) {
    syncForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Show modal with progress indicator
      syncModal.style.display = 'block';
      syncModalBody.innerHTML = `
        <div class="sync-progress">
          <div class="sync-spinner"></div>
          <p>Synchronizing providers...</p>
        </div>
      `;
      syncModalFooter.style.display = 'none';

      async function parseErrorResponse(response) {
        try {
          const data = await response.json();
          return data.detail || data.message || JSON.stringify(data);
        } catch (error) {
          const text = await response.text();
          return text || response.statusText;
        }
      }

      try {
        const response = await fetch('/sync', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          const errorDetail = await parseErrorResponse(response);
          throw new Error(`HTTP ${response.status}: ${errorDetail}`);
        }

        const results = await response.json();

        // Display results
        let html = '<div class="sync-results">';

        // Summary
        html += `
          <div class="sync-summary">
            <h3>Synchronization ${results.success ? 'Completed' : 'Completed with Errors'}</h3>
            <div class="sync-stat">
              <span class="sync-stat-label">Total Providers</span>
              <span class="sync-stat-value">${results.total_providers}</span>
            </div>
            <div class="sync-stat">
              <span class="sync-stat-label">Total Models Fetched</span>
              <span class="sync-stat-value">${results.total_models_fetched}</span>
            </div>
            ${results.errors.length > 0 ? `
              <div class="sync-stat">
                <span class="sync-stat-label">Errors</span>
                <span class="sync-stat-value" style="color: #d32f2f;">${results.errors.length}</span>
              </div>
            ` : ''}
          </div>
        `;

        // Provider results
        if (results.providers.length > 0) {
          html += '<div class="provider-results">';
          html += '<h3 style="margin-bottom: 1rem;">Provider Details</h3>';

          results.providers.forEach(provider => {
            const isError = provider.status === 'error';
            html += `
              <div class="provider-result ${isError ? 'error' : 'success'}">
                <h4>${provider.name}</h4>
                ${!isError ? `
                  <div class="provider-stats">
                    <div class="provider-stat">
                      <div class="provider-stat-label">Fetched</div>
                      <div class="provider-stat-value">${provider.models_fetched}</div>
                    </div>
                    <div class="provider-stat">
                      <div class="provider-stat-label">Added</div>
                      <div class="provider-stat-value">${provider.models_added}</div>
                    </div>
                    <div class="provider-stat">
                      <div class="provider-stat-label">Updated</div>
                      <div class="provider-stat-value">${provider.models_updated}</div>
                    </div>
                    <div class="provider-stat">
                      <div class="provider-stat-label">Orphaned</div>
                      <div class="provider-stat-value">${provider.models_orphaned}</div>
                    </div>
                  </div>
                ` : `
                  <div class="error-message">Error: ${provider.error}</div>
                `}
              </div>
            `;
          });

          html += '</div>';
        }

        html += '</div>';

        syncModalBody.innerHTML = html;
        syncModalFooter.style.display = 'flex';

      } catch (error) {
        syncModalBody.innerHTML = `
          <div class="sync-results">
            <div class="provider-result error">
              <h4>Synchronization Failed</h4>
              <div class="error-message">${error.message}</div>
            </div>
          </div>
        `;
        syncModalFooter.style.display = 'flex';
      }
    });
  }
});

function closeSyncModal() {
  document.getElementById('sync-modal').style.display = 'none';
}

// Close modal when clicking outside
window.onclick = function(event) {
  const modal = document.getElementById('sync-modal');
  if (event.target === modal) {
    closeSyncModal();
  }
};
</script>
{% endblock %}
