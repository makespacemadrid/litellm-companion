{% extends "base.html" %}
{% block content %}
<section class="panel">
  <h2>Completion Models</h2>
  <p class="muted">
    Create completion-mode aliases from existing database models.
    Each entry becomes <code>original-model-completion</code> and uses completion-mode routing.
  </p>

  <div class="completion-actions">
    <button class="btn-primary" onclick="openAddCompletionModal()">Add Completion Model</button>
  </div>

  <div id="completion-list">Loading completion models...</div>
</section>

<div id="completion-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Add Completion Model</h3>
      <span class="close" onclick="closeCompletionModal()">&times;</span>
    </div>
    <div class="modal-body">
      <form id="completion-form" onsubmit="saveCompletionModel(event)">
        <label>Source Provider <span style="color: red;">*</span></label>
        <select id="completion-provider" required>
          <option value="">-- Select a provider --</option>
        </select>

        <label>Source Model <span style="color: red;">*</span></label>
        <select id="completion-model" required>
          <option value="">-- Select a provider first --</option>
        </select>
        <p class="muted" style="margin-top: -0.5rem; margin-bottom: 1rem;">
          The completion model will be created as <code>model_id-completion</code>.
        </p>

        <div class="modal-actions">
          <button type="button" onclick="closeCompletionModal()">Cancel</button>
          <button type="submit" class="btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
.completion-actions {
  margin-bottom: 1.5rem;
}

.completion-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}

.completion-table th,
.completion-table td {
  padding: 0.75rem;
  text-align: left;
  border-bottom: 1px solid #e0e0e0;
}

.completion-table th {
  background: #f5f5f5;
  font-weight: 600;
}

.completion-table tr:hover {
  background: #fafafa;
}

.completion-row-actions {
  display: flex;
  gap: 0.5rem;
}

.completion-row-actions button {
  padding: 0.4rem 0.8rem;
  font-size: 0.85rem;
}

.badge-mapping {
  background: #1976d2;
  color: white;
  padding: 0.25rem 0.5rem;
  border-radius: 3px;
  font-size: 0.85rem;
}

.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
  background-color: white;
  margin: 5% auto;
  padding: 0;
  border-radius: 8px;
  width: 90%;
  max-width: 600px;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1rem 1.5rem;
  border-bottom: 1px solid #e0e0e0;
}

.modal-header h3 {
  margin: 0;
}

.modal-body {
  padding: 1.5rem;
}

.modal-actions {
  display: flex;
  gap: 0.5rem;
  justify-content: flex-end;
  margin-top: 1.5rem;
}

.close {
  color: #aaa;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

.close:hover,
.close:focus {
  color: #000;
}

label {
  display: block;
  margin-bottom: 0.5rem;
  font-weight: 500;
}

select {
  width: 100%;
  padding: 0.5rem;
  margin-bottom: 1rem;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.btn-primary {
  background: #1976d2;
  color: white;
  padding: 0.6rem 1.2rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.btn-primary:hover {
  background: #1565c0;
}

.btn-danger {
  background: #d32f2f;
  color: white;
  padding: 0.6rem 1.2rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
}

.btn-danger:hover {
  background: #b71c1c;
}

.muted {
  color: #666;
  font-size: 0.9rem;
}
</style>

<script>
let completionModels = [];
let providers = [];
let providerModels = {};

async function loadCompletionModels() {
  try {
    const response = await fetch('/api/completion/models');
    completionModels = await response.json();
    renderCompletionModels();
  } catch (error) {
    document.getElementById('completion-list').innerHTML =
      `<p style="color: red;">Error loading completion models: ${error.message}</p>`;
  }
}

async function loadProviders() {
  try {
    const response = await fetch('/api/providers');
    providers = await response.json();
    providers = providers.filter(p => !['compat', 'completion'].includes(p.type));
    updateProviderDropdown();
  } catch (error) {
    console.error('Error loading providers:', error);
  }
}

function updateProviderDropdown() {
  const select = document.getElementById('completion-provider');
  const currentValue = select.value;

  select.innerHTML = '<option value="">-- Select a provider --</option>';

  providers.forEach(provider => {
    const option = document.createElement('option');
    option.value = provider.id;
    option.textContent = `${provider.name} (${provider.type})`;
    select.appendChild(option);
  });

  if (currentValue) {
    select.value = currentValue;
  }
}

async function loadProviderModels(providerId) {
  if (!providerId) {
    document.getElementById('completion-model').innerHTML = '<option value="">-- Select a provider first --</option>';
    return;
  }

  if (providerModels[providerId]) {
    updateModelDropdown(providerId);
    return;
  }

  try {
    const response = await fetch(`/api/providers/${providerId}/models?include_orphaned=false`);
    const data = await response.json();
    providerModels[providerId] = Array.isArray(data) ? data : (data.models || []);
    updateModelDropdown(providerId);
  } catch (error) {
    console.error('Error loading provider models:', error);
  }
}

function updateModelDropdown(providerId) {
  const select = document.getElementById('completion-model');
  const models = providerModels[providerId] || [];

  select.innerHTML = '<option value="">-- Select a model --</option>';
  models.forEach(model => {
    const option = document.createElement('option');
    option.value = model.model_id;
    option.textContent = model.display_name || model.model_id;
    select.appendChild(option);
  });
}

function renderCompletionModels() {
  const container = document.getElementById('completion-list');

  if (completionModels.length === 0) {
    container.innerHTML = '<p class="muted">No completion models defined yet. Click "Add Completion Model" to create one.</p>';
    return;
  }

  const rows = completionModels.map(model => {
    const mappingBadge = model.mapped_provider
      ? `<span class="badge-mapping">${model.mapped_provider.name} -> ${model.mapped_model_id}</span>`
      : '<span class="muted">Unknown mapping</span>';

    return `
      <tr>
        <td><strong>${model.model_name}</strong></td>
        <td>${mappingBadge}</td>
        <td>
          <div class="completion-row-actions">
            <button class="btn-danger" onclick="deleteCompletionModel(${model.id}, '${model.model_name}')">Delete</button>
          </div>
        </td>
      </tr>
    `;
  }).join('');

  container.innerHTML = `
    <table class="completion-table">
      <thead>
        <tr>
          <th>Completion Model</th>
          <th>Mapping</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        ${rows}
      </tbody>
    </table>
  `;
}

function openAddCompletionModal() {
  document.getElementById('completion-form').reset();
  document.getElementById('completion-modal').style.display = 'block';
  updateProviderDropdown();
}

function closeCompletionModal() {
  document.getElementById('completion-modal').style.display = 'none';
}

async function saveCompletionModel(event) {
  event.preventDefault();

  const providerId = document.getElementById('completion-provider').value;
  const modelId = document.getElementById('completion-model').value;

  const formData = new FormData();
  formData.append('mapped_provider_id', providerId);
  formData.append('mapped_model_id', modelId);

  try {
    const response = await fetch('/api/completion/models', {
      method: 'POST',
      body: formData
    });

    const result = await response.json();
    if (response.ok) {
      alert(`OK: ${result.message}`);
      closeCompletionModal();
      await loadCompletionModels();
    } else {
      alert(`Error: ${result.detail || 'Unknown error'}`);
    }
  } catch (error) {
    alert(`Error: ${error.message}`);
  }
}

async function deleteCompletionModel(modelId, modelName) {
  if (!confirm(`Are you sure you want to delete completion model "${modelName}"?`)) {
    return;
  }

  try {
    const response = await fetch(`/api/completion/models/${modelId}`, {
      method: 'DELETE'
    });

    const result = await response.json();
    if (response.ok) {
      alert(`OK: ${result.message}`);
      await loadCompletionModels();
    } else {
      alert(`Error: ${result.detail || 'Unknown error'}`);
    }
  } catch (error) {
    alert(`Error: ${error.message}`);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  loadCompletionModels();
  loadProviders();

  const providerSelect = document.getElementById('completion-provider');
  providerSelect.addEventListener('change', (e) => {
    loadProviderModels(e.target.value);
  });
});

window.onclick = function(event) {
  const modal = document.getElementById('completion-modal');
  if (event.target === modal) {
    closeCompletionModal();
  }
}
</script>

{% endblock %}
