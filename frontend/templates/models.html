{% extends "base.html" %}
{% block content %}
<section class="panel">
  <h2>Models Browser</h2>
  <p class="muted">
    Search and filter models across all providers
  </p>

  <!-- Search and Filters -->
  <div class="filters-panel">
    <div class="search-box">
      <input type="text" id="search-input" placeholder="Search by model name..." />
    </div>

    <div class="filters-grid">
      <!-- Category Filter -->
      <div class="filter-group">
        <label>Category</label>
        <select id="filter-category" multiple size="5">
          <option value="">All</option>
          <option value="chat">üí¨ Chat</option>
          <option value="vision">üëÅÔ∏è Vision</option>
          <option value="code">üíª Code</option>
          <option value="reasoning">üß† Reasoning</option>
          <option value="embedding">üî¢ Embedding</option>
          <option value="audio">üé§ Audio</option>
          <option value="image">üé® Image</option>
        </select>
      </div>

      <!-- Provider Filter -->
      <div class="filter-group">
        <label>Provider</label>
        <select id="filter-provider" multiple size="5">
          <option value="">All</option>
        </select>
      </div>

      <!-- Context Window Filter -->
      <div class="filter-group">
        <label>Context Window</label>
        <select id="filter-context">
          <option value="">All</option>
          <option value="0-4096">0 - 4K</option>
          <option value="4097-8192">4K - 8K</option>
          <option value="8193-16384">8K - 16K</option>
          <option value="16385-32768">16K - 32K</option>
          <option value="32769-65536">32K - 64K</option>
          <option value="65537-131072">64K - 128K</option>
          <option value="131073-999999999">128K+</option>
        </select>
      </div>

      <!-- Capabilities Filter -->
      <div class="filter-group filter-group-checkboxes">
        <label>Capabilities</label>
        <div class="checkbox-group">
          <label><input type="checkbox" value="vision" class="cap-checkbox" /> Vision</label>
          <label><input type="checkbox" value="function calling" class="cap-checkbox" /> Function Calling</label>
          <label><input type="checkbox" value="tools" class="cap-checkbox" /> Tools</label>
          <label><input type="checkbox" value="thinking" class="cap-checkbox" /> Thinking</label>
          <label><input type="checkbox" value="embedding" class="cap-checkbox" /> Embedding</label>
          <label><input type="checkbox" value="audio" class="cap-checkbox" /> Audio</label>
        </div>
      </div>

      <!-- Status Filter -->
      <div class="filter-group filter-group-checkboxes">
        <label>Status</label>
        <div class="checkbox-group">
          <label><input type="checkbox" id="filter-modified" /> User Modified</label>
          <label><input type="checkbox" id="filter-sync-enabled" /> Sync Enabled</label>
          <label><input type="checkbox" id="filter-sync-disabled" /> Sync Disabled</label>
        </div>
      </div>
    </div>

    <div class="filter-actions">
      <button class="btn-secondary" onclick="clearFilters()">Clear All</button>
      <span class="filter-separator"></span>
      <label class="toggle-label">
        <input type="checkbox" id="hide-orphaned" checked />
        <span>Hide Orphaned</span>
      </label>
    </div>
  </div>

  <!-- Results Summary -->
  <div class="results-summary">
    <span id="results-count">Loading...</span>
  </div>

  <!-- Models Grid -->
  <div id="models-grid" class="models-grid">
    Loading models...
  </div>
</section>

<!-- Model Detail Modal -->
<div id="model-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modal-title">Model Details</h2>
      <span class="modal-close" onclick="closeModal()">&times;</span>
    </div>
    <div class="modal-body" id="modal-body">
      Loading...
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeModal()">Close</button>
    </div>
  </div>
</div>

<style>
.filters-panel {
  background: #f9f9f9;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}

.search-box {
  margin-bottom: 1rem;
}

.search-box input {
  width: 100%;
  padding: 0.75rem;
  font-size: 1rem;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  transition: border-color 0.2s;
}

.search-box input:focus {
  outline: none;
  border-color: #1976d2;
}

.filters-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  margin-bottom: 1rem;
}

@media (max-width: 1200px) {
  .filters-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (max-width: 768px) {
  .filters-grid {
    grid-template-columns: 1fr;
  }
}

.filter-group {
  display: flex;
  flex-direction: column;
}

.filter-group > label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.4rem;
  color: #333;
  font-size: 0.9rem;
}

.filter-group select {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid #ddd;
  border-radius: 4px;
  background: white;
  flex: 1;
}

.filter-group-checkboxes {
  display: flex;
  flex-direction: column;
}

.checkbox-group {
  display: flex;
  flex-direction: column;
  gap: 0.15rem;
  padding: 0.4rem 0.5rem;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
  flex: 1;
  min-height: 0;
}

.checkbox-group label {
  display: flex;
  align-items: center;
  gap: 0.3rem;
  font-weight: 400;
  font-size: 0.8rem;
  cursor: pointer;
  margin-bottom: 0;
  line-height: 1.4;
}

.checkbox-group input[type="checkbox"] {
  cursor: pointer;
  width: 14px;
  height: 14px;
  margin: 0;
}

.filter-actions {
  display: flex;
  gap: 1rem;
  align-items: center;
  padding-top: 1rem;
  border-top: 1px solid #e0e0e0;
}

.results-summary {
  padding: 0.75rem 1rem;
  background: #f0f7ff;
  border-left: 3px solid #1976d2;
  border-radius: 4px;
  margin-bottom: 1rem;
  font-weight: 500;
}

.models-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 1rem;
}

.model-card {
  background: white;
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 1rem;
  transition: all 0.2s;
  cursor: pointer;
}

.model-card:hover {
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  transform: translateY(-2px);
  border-color: #1976d2;
}

.model-card.orphaned {
  background: #ffebee;
  border-color: #d32f2f;
  opacity: 0.7;
}

.model-header {
  display: flex;
  justify-content: space-between;
  align-items: start;
  margin-bottom: 0.75rem;
}

.model-name {
  font-weight: 700;
  font-size: 1rem;
  color: #1976d2;
  word-break: break-word;
}

.model-card.orphaned .model-name {
  color: #d32f2f;
}

.model-category {
  font-size: 1.5rem;
  flex-shrink: 0;
}

.model-provider {
  color: #666;
  font-size: 0.85rem;
  margin-bottom: 0.5rem;
}

.model-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
}

.meta-badge {
  display: inline-flex;
  align-items: center;
  padding: 0.25rem 0.5rem;
  background: #f0f7ff;
  border: 1px solid #cfe3ff;
  border-radius: 12px;
  font-size: 0.75rem;
  color: #1976d2;
  font-weight: 500;
}

.capabilities-list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.25rem;
  margin-top: 0.5rem;
}

.cap-badge {
  padding: 0.2rem 0.5rem;
  background: #e8f5e9;
  border: 1px solid #c8e6c9;
  border-radius: 8px;
  font-size: 0.7rem;
  color: #2e7d32;
}

.btn-primary {
  background: #1976d2;
  color: white;
  padding: 0.6rem 1.2rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9rem;
}

.btn-primary:hover {
  background: #1565c0;
}

.btn-secondary {
  background: #757575;
  color: white;
  padding: 0.6rem 1.2rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.9rem;
}

.btn-secondary:hover {
  background: #616161;
}

.toggle-label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
}

.filter-separator {
  width: 1px;
  height: 24px;
  background: #ddd;
  margin: 0 0.5rem;
}

/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.5);
}

.modal-content {
  background-color: #fff;
  margin: 2% auto;
  border-radius: 12px;
  width: 90%;
  max-width: 900px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem;
  border-bottom: 1px solid #e0e0e0;
}

.modal-header h2 {
  margin: 0;
  color: #1976d2;
}

.modal-close {
  font-size: 2rem;
  font-weight: 300;
  color: #999;
  cursor: pointer;
  line-height: 1;
  transition: color 0.2s;
}

.modal-close:hover {
  color: #333;
}

.modal-body {
  padding: 1.5rem;
  overflow-y: auto;
  flex: 1;
}

.modal-footer {
  padding: 1rem 1.5rem;
  border-top: 1px solid #e0e0e0;
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
}

.detail-section {
  margin-bottom: 1.5rem;
}

.detail-section h3 {
  margin: 0 0 0.75rem 0;
  color: #333;
  font-size: 1.1rem;
  border-bottom: 2px solid #1976d2;
  padding-bottom: 0.5rem;
}

.detail-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
}

.detail-item {
  padding: 0.5rem;
  background: #f9f9f9;
  border-radius: 4px;
}

.detail-label {
  font-size: 0.85rem;
  color: #666;
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.detail-value {
  font-size: 0.95rem;
  color: #333;
  word-break: break-word;
}

.detail-value code {
  background: #e8f5e9;
  padding: 0.2rem 0.4rem;
  border-radius: 3px;
  font-size: 0.9rem;
}

.tags-list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.tag-item {
  padding: 0.3rem 0.7rem;
  background: #e3f2fd;
  border: 1px solid #90caf9;
  border-radius: 12px;
  font-size: 0.85rem;
  color: #1976d2;
}

.json-viewer {
  background: #f5f5f5;
  border: 1px solid #ddd;
  border-radius: 4px;
  padding: 1rem;
  font-family: 'Courier New', monospace;
  font-size: 0.85rem;
  overflow-x: auto;
  white-space: pre-wrap;
  word-break: break-all;
}

.capabilities-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 0.75rem;
  margin-top: 0.5rem;
}

.capability-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 8px;
  font-size: 0.9rem;
  font-weight: 500;
  transition: transform 0.2s, box-shadow 0.2s;
}

.capability-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.capability-icon {
  font-size: 1.5rem;
  flex-shrink: 0;
}

.capability-name {
  flex: 1;
}
</style>

<script>
let allModels = [];
let filteredModels = [];
let providers = [];

// Category icons
const categoryIcons = {
  chat: 'üí¨',
  vision: 'üëÅÔ∏è',
  code: 'üíª',
  reasoning: 'üß†',
  embedding: 'üî¢',
  audio: 'üé§',
  image: 'üé®',
  unknown: '‚ùì'
};

async function loadData() {
  try {
    // Load providers
    const providersResp = await fetch('/api/providers');
    providers = await providersResp.json();

    // Populate provider filter
    const providerSelect = document.getElementById('filter-provider');
    providers.forEach(p => {
      if (p.type !== 'compat' && p.type !== 'completion') {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = p.name;
        providerSelect.appendChild(option);
      }
    });

    // Load all models from all providers
    allModels = [];
    for (const provider of providers) {
      if (provider.type === 'compat' || provider.type === 'completion') continue;

      const response = await fetch(`/api/providers/${provider.id}/models?include_orphaned=true`);
      const data = await response.json();
      const models = Array.isArray(data) ? data : (data.models || []);

      // Add provider info to each model
      models.forEach(m => {
        m.provider_name = provider.name;
        m.provider_id = provider.id;
      });

      allModels.push(...models);
    }

    // Get categories for each model
    await categorizeModels();

    // Apply URL filters if present
    applyUrlFilters();

    // Apply initial filters
    applyFilters();
  } catch (error) {
    document.getElementById('models-grid').innerHTML = `<p style="color: red;">Error loading models: ${error.message}</p>`;
  }
}

async function categorizeModels() {
  // Use the categorization endpoint to get categories
  for (const model of allModels) {
    // Simple categorization based on capabilities
    const caps = model.capabilities || [];
    const capsLower = caps.map(c => c.toLowerCase());

    if (capsLower.includes('vision')) {
      model.category = 'vision';
    } else if (capsLower.includes('embedding')) {
      model.category = 'embedding';
    } else if (capsLower.includes('audio')) {
      model.category = 'audio';
    } else if (capsLower.includes('thinking')) {
      model.category = 'reasoning';
    } else if (model.model_id.toLowerCase().includes('coder') || model.model_id.toLowerCase().includes('code')) {
      model.category = 'code';
    } else if (capsLower.some(c => ['chat', 'completion', 'tools', 'function calling'].includes(c))) {
      model.category = 'chat';
    } else {
      model.category = 'unknown';
    }
  }
}

function applyFilters() {
  const searchTerm = document.getElementById('search-input').value.toLowerCase();
  const selectedCategories = Array.from(document.getElementById('filter-category').selectedOptions).map(o => o.value).filter(v => v);
  const selectedProviders = Array.from(document.getElementById('filter-provider').selectedOptions).map(o => o.value).filter(v => v);
  const contextRange = document.getElementById('filter-context').value;
  const selectedCaps = Array.from(document.querySelectorAll('.cap-checkbox:checked')).map(cb => cb.value);
  const hideOrphaned = document.getElementById('hide-orphaned').checked;
  const filterModified = document.getElementById('filter-modified').checked;
  const filterSyncEnabled = document.getElementById('filter-sync-enabled').checked;
  const filterSyncDisabled = document.getElementById('filter-sync-disabled').checked;

  filteredModels = allModels.filter(model => {
    // Search filter
    if (searchTerm && !model.model_id.toLowerCase().includes(searchTerm)) {
      return false;
    }

    // Category filter
    if (selectedCategories.length > 0 && !selectedCategories.includes(model.category)) {
      return false;
    }

    // Provider filter
    if (selectedProviders.length > 0 && !selectedProviders.includes(String(model.provider_id))) {
      return false;
    }

    // Context window filter
    if (contextRange) {
      const [min, max] = contextRange.split('-').map(Number);
      const context = model.context_window || 0;
      if (context < min || context > max) {
        return false;
      }
    }

    // Capabilities filter
    if (selectedCaps.length > 0) {
      const modelCaps = (model.capabilities || []).map(c => c.toLowerCase());
      const hasAllCaps = selectedCaps.every(cap => modelCaps.includes(cap.toLowerCase()));
      if (!hasAllCaps) {
        return false;
      }
    }

    // Status filters
    if (filterModified && !model.user_modified) {
      return false;
    }
    if (filterSyncEnabled && !model.sync_enabled) {
      return false;
    }
    if (filterSyncDisabled && model.sync_enabled) {
      return false;
    }

    // Orphaned filter
    if (hideOrphaned && model.is_orphaned) {
      return false;
    }

    return true;
  });

  renderModels();
}

function renderModels() {
  const container = document.getElementById('models-grid');
  const resultsCount = document.getElementById('results-count');

  resultsCount.textContent = `Showing ${filteredModels.length} of ${allModels.length} models`;

  if (filteredModels.length === 0) {
    container.innerHTML = '<p class="muted">No models match your filters</p>';
    return;
  }

  const cards = filteredModels.map(model => {
    const icon = categoryIcons[model.category] || 'üì¶';
    const contextDisplay = model.context_window ? `${(model.context_window / 1024).toFixed(0)}K` : 'N/A';

    return `
      <div class="model-card ${model.is_orphaned ? 'orphaned' : ''}" onclick="showModelDetails(${model.id})">
        <div class="model-header">
          <div>
            <div class="model-name">${model.display_name || model.model_id}</div>
            <div class="model-provider">${model.provider_name}</div>
          </div>
          <div class="model-category" title="${model.category}">${icon}</div>
        </div>

        <div class="model-meta">
          ${model.context_window ? `<span class="meta-badge">üìè ${contextDisplay} context</span>` : ''}
          ${model.is_orphaned ? `<span class="meta-badge" style="background: #ffebee; border-color: #ffccc2; color: #d32f2f;">‚ö†Ô∏è Orphaned</span>` : ''}
          ${model.user_modified ? `<span class="meta-badge" style="background: #f0f7ff;">‚úèÔ∏è Modified</span>` : ''}
        </div>

        ${model.capabilities && model.capabilities.length > 0 ? `
          <div class="capabilities-list">
            ${model.capabilities.slice(0, 5).map(cap => `<span class="cap-badge">${cap}</span>`).join('')}
            ${model.capabilities.length > 5 ? `<span class="cap-badge">+${model.capabilities.length - 5}</span>` : ''}
          </div>
        ` : ''}
      </div>
    `;
  }).join('');

  container.innerHTML = cards;
}

function clearFilters() {
  document.getElementById('search-input').value = '';
  document.getElementById('filter-category').selectedIndex = -1;
  document.getElementById('filter-provider').selectedIndex = -1;
  document.getElementById('filter-context').selectedIndex = 0;
  document.querySelectorAll('.cap-checkbox').forEach(cb => cb.checked = false);
  document.getElementById('filter-modified').checked = false;
  document.getElementById('filter-sync-enabled').checked = false;
  document.getElementById('filter-sync-disabled').checked = false;
  document.getElementById('hide-orphaned').checked = true;
  applyFilters();
}

// Parse URL parameters and apply filters
function applyUrlFilters() {
  const urlParams = new URLSearchParams(window.location.search);

  // Apply category filter
  const category = urlParams.get('category');
  if (category) {
    const categorySelect = document.getElementById('filter-category');
    for (let option of categorySelect.options) {
      if (option.value === category) {
        option.selected = true;
        break;
      }
    }
  }

  // Apply provider filter
  const provider = urlParams.get('provider');
  if (provider) {
    const providerSelect = document.getElementById('filter-provider');
    for (let option of providerSelect.options) {
      if (option.value === provider) {
        option.selected = true;
        break;
      }
    }
  }

  // Apply search term
  const search = urlParams.get('search');
  if (search) {
    document.getElementById('search-input').value = search;
  }

  // Apply context window filter
  const context = urlParams.get('context');
  if (context) {
    document.getElementById('filter-context').value = context;
  }

  // Apply capabilities filter
  const capabilities = urlParams.get('capabilities');
  if (capabilities) {
    const caps = capabilities.split(',');
    document.querySelectorAll('.cap-checkbox').forEach(cb => {
      if (caps.includes(cb.value)) {
        cb.checked = true;
      }
    });
  }
}

// Helper function to get capability icon
function getCapabilityIcon(capability) {
  const cap = capability.toLowerCase();
  if (cap.includes('vision') || cap.includes('image')) return 'üëÅÔ∏è';
  if (cap.includes('audio') || cap.includes('speech')) return 'üé§';
  if (cap.includes('function') || cap.includes('tool')) return 'üîß';
  if (cap.includes('thinking') || cap.includes('reasoning')) return 'üß†';
  if (cap.includes('embedding')) return 'üî¢';
  if (cap.includes('chat') || cap.includes('completion')) return 'üí¨';
  if (cap.includes('code')) return 'üíª';
  return '‚ú®';
}

// Helper function to format pricing
function formatPricing(value) {
  if (!value) return 'N/A';
  const num = parseFloat(value);
  if (num === 0) return 'Free';
  if (num < 0.000001) return num.toExponential(2);
  if (num < 0.01) return `$${num.toFixed(6)}`;
  return `$${num.toFixed(4)}`;
}

// Model details modal functions
async function showModelDetails(modelId) {
  const modal = document.getElementById('model-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalBody = document.getElementById('modal-body');

  modal.style.display = 'block';
  modalBody.innerHTML = '<p>Loading model details...</p>';

  try {
    const response = await fetch(`/api/models/${modelId}`);
    if (!response.ok) throw new Error('Failed to load model details');

    const model = await response.json();

    // Find provider info
    const provider = providers.find(p => p.id === model.provider_id);

    modalTitle.textContent = model.display_name || model.model_id;

    // Build detail sections
    let html = '';

    // Basic Information
    html += `
      <div class="detail-section">
        <h3>Basic Information</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <div class="detail-label">Model ID</div>
            <div class="detail-value"><code>${model.model_id}</code></div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Display Name</div>
            <div class="detail-value">${model.display_name || model.model_id}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Provider</div>
            <div class="detail-value">${provider ? provider.name : 'Unknown'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Category</div>
            <div class="detail-value">${categoryIcons[model.category] || 'üì¶'} ${model.category ? model.category.charAt(0).toUpperCase() + model.category.slice(1) : 'Unknown'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Status</div>
            <div class="detail-value">
              ${model.is_orphaned ? '<span style="color: #d32f2f;">‚ö†Ô∏è Orphaned</span>' : '<span style="color: #2e7d32;">‚úì Active</span>'}
            </div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Sync Enabled</div>
            <div class="detail-value">${model.sync_enabled ? '‚úì Yes' : '‚úó No'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">User Modified</div>
            <div class="detail-value">${model.user_modified ? '‚úì Yes' : '‚úó No'}</div>
          </div>
        </div>
      </div>
    `;

    // Model Specifications
    html += `
      <div class="detail-section">
        <h3>Model Specifications</h3>
        <div class="detail-grid">
          ${model.context_window ? `
            <div class="detail-item">
              <div class="detail-label">Context Window</div>
              <div class="detail-value">${(model.context_window).toLocaleString()} tokens</div>
            </div>
          ` : ''}
          ${model.max_input_tokens ? `
            <div class="detail-item">
              <div class="detail-label">Max Input Tokens</div>
              <div class="detail-value">${(model.max_input_tokens).toLocaleString()}</div>
            </div>
          ` : ''}
          ${model.max_output_tokens ? `
            <div class="detail-item">
              <div class="detail-label">Max Output Tokens</div>
              <div class="detail-value">${(model.max_output_tokens).toLocaleString()}</div>
            </div>
          ` : ''}
          ${model.max_tokens ? `
            <div class="detail-item">
              <div class="detail-label">Max Tokens</div>
              <div class="detail-value">${(model.max_tokens).toLocaleString()}</div>
            </div>
          ` : ''}
        </div>
      </div>
    `;

    // Capabilities
    if (model.capabilities && model.capabilities.length > 0) {
      html += `
        <div class="detail-section">
          <h3>Capabilities</h3>
          <div class="capabilities-grid">
            ${model.capabilities.map(cap => `
              <div class="capability-item">
                <span class="capability-icon">${getCapabilityIcon(cap)}</span>
                <span class="capability-name">${cap}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // Tags
    if (model.user_tags && model.user_tags.length > 0) {
      html += `
        <div class="detail-section">
          <h3>User Tags</h3>
          <div class="tags-list">
            ${model.user_tags.map(tag => `<span class="tag-item">${tag}</span>`).join('')}
          </div>
        </div>
      `;
    }

    // Pricing
    const effectiveParams = model.user_params || model.litellm_params || {};
    const hasInputPrice = effectiveParams.input_cost_per_token !== undefined;
    const hasOutputPrice = effectiveParams.output_cost_per_token !== undefined;
    const hasPricing = hasInputPrice || hasOutputPrice || model.pricing_profile;

    if (hasPricing) {
      html += `
        <div class="detail-section">
          <h3>Pricing</h3>
          <div class="detail-grid">
            ${model.pricing_profile ? `
              <div class="detail-item">
                <div class="detail-label">Pricing Profile</div>
                <div class="detail-value">${model.pricing_profile}</div>
              </div>
            ` : ''}
            ${hasInputPrice ? `
              <div class="detail-item">
                <div class="detail-label">Input Cost per Token ${model.pricing_override ? '(Custom)' : '(Inherited)'}</div>
                <div class="detail-value">${formatPricing(effectiveParams.input_cost_per_token)}</div>
              </div>
            ` : ''}
            ${hasOutputPrice ? `
              <div class="detail-item">
                <div class="detail-label">Output Cost per Token ${model.pricing_override ? '(Custom)' : '(Inherited)'}</div>
                <div class="detail-value">${formatPricing(effectiveParams.output_cost_per_token)}</div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    // Timestamps
    const formatDate = (dateStr) => {
      if (!dateStr) return 'Never';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      let relative = '';
      if (diffMins < 1) relative = 'just now';
      else if (diffMins < 60) relative = `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
      else if (diffHours < 24) relative = `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
      else if (diffDays < 7) relative = `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
      else relative = date.toLocaleDateString();

      return `${relative}<br><span style="font-size: 0.85em; color: #999;">${date.toLocaleString()}</span>`;
    };

    html += `
      <div class="detail-section">
        <h3>Model History</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <div class="detail-label">First Seen</div>
            <div class="detail-value">${formatDate(model.first_seen)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Last Seen</div>
            <div class="detail-value">${formatDate(model.last_seen)}</div>
          </div>
          ${model.is_orphaned && model.orphaned_at ? `
            <div class="detail-item">
              <div class="detail-label">Orphaned Since</div>
              <div class="detail-value" style="color: #d32f2f;">${formatDate(model.orphaned_at)}</div>
            </div>
          ` : ''}
          <div class="detail-item">
            <div class="detail-label">Created</div>
            <div class="detail-value">${formatDate(model.created_at)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Last Updated</div>
            <div class="detail-value">${formatDate(model.updated_at)}</div>
          </div>
        </div>
      </div>
    `;

    // LiteLLM Parameters (collapsed by default)
    if (model.litellm_params) {
      html += `
        <div class="detail-section">
          <h3>LiteLLM Parameters</h3>
          <div class="json-viewer">${JSON.stringify(model.litellm_params, null, 2)}</div>
        </div>
      `;
    }

    // User Parameters (if set)
    if (model.user_params) {
      html += `
        <div class="detail-section">
          <h3>User Parameters (Override)</h3>
          <div class="json-viewer">${JSON.stringify(model.user_params, null, 2)}</div>
        </div>
      `;
    }

    modalBody.innerHTML = html;
  } catch (error) {
    modalBody.innerHTML = `<p style="color: red;">Error loading model details: ${error.message}</p>`;
  }
}

function closeModal() {
  document.getElementById('model-modal').style.display = 'none';
}

// Close modal when clicking outside of it
window.onclick = function(event) {
  const modal = document.getElementById('model-modal');
  if (event.target === modal) {
    closeModal();
  }
}

// Real-time search and auto-apply filters
document.addEventListener('DOMContentLoaded', () => {
  loadData();

  // Auto-apply on search input
  document.getElementById('search-input').addEventListener('input', () => {
    applyFilters();
  });

  // Auto-apply on select changes
  document.getElementById('filter-category').addEventListener('change', () => {
    applyFilters();
  });

  document.getElementById('filter-provider').addEventListener('change', () => {
    applyFilters();
  });

  document.getElementById('filter-context').addEventListener('change', () => {
    applyFilters();
  });

  // Auto-apply on checkbox changes
  document.getElementById('hide-orphaned').addEventListener('change', () => {
    applyFilters();
  });

  document.getElementById('filter-modified').addEventListener('change', () => {
    applyFilters();
  });

  document.getElementById('filter-sync-enabled').addEventListener('change', () => {
    applyFilters();
  });

  document.getElementById('filter-sync-disabled').addEventListener('change', () => {
    applyFilters();
  });

  // Auto-apply on capability checkbox changes
  document.querySelectorAll('.cap-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', () => {
      applyFilters();
    });
  });
});
</script>

{% endblock %}
