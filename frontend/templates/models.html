{% extends "base.html" %}
{% block content %}
<section class="panel">
  <h2>Models Browser</h2>
  <p class="muted">
    Search and filter models across all providers
  </p>

  <!-- Search and Filters -->
  <div class="filters-panel">
    <div class="search-box">
      <input type="text" id="search-input" placeholder="Search by model name..." />
    </div>

    <div class="filters-grid">
      <!-- Category Filter -->
      <div class="filter-group">
        <label>Category</label>
        <select id="filter-category" multiple size="5">
          <option value="">All</option>
          <option value="chat">üí¨ Chat</option>
          <option value="vision">üëÅÔ∏è Vision</option>
          <option value="code">üíª Code</option>
          <option value="reasoning">üß† Reasoning</option>
          <option value="embedding">üî¢ Embedding</option>
          <option value="audio">üé§ Audio</option>
          <option value="image">üé® Image</option>
        </select>
      </div>

      <!-- Provider Filter -->
      <div class="filter-group">
        <label>Provider</label>
        <select id="filter-provider" multiple size="5">
          <option value="">All</option>
        </select>
      </div>

      <!-- Context Window Filter -->
      <div class="filter-group">
        <label>Context Window</label>
        <select id="filter-context">
          <option value="">All</option>
          <option value="0-4096">0 - 4K</option>
          <option value="4097-8192">4K - 8K</option>
          <option value="8193-16384">8K - 16K</option>
          <option value="16385-32768">16K - 32K</option>
          <option value="32769-65536">32K - 64K</option>
          <option value="65537-131072">64K - 128K</option>
          <option value="131073-999999999">128K+</option>
        </select>
      </div>

      <!-- Capabilities Filter -->
      <div class="filter-group filter-group-checkboxes">
        <label>Capabilities</label>
        <div class="checkbox-group">
          <label><input type="checkbox" value="vision" class="cap-checkbox" /> Vision</label>
          <label><input type="checkbox" value="function calling" class="cap-checkbox" /> Function Calling</label>
          <label><input type="checkbox" value="tools" class="cap-checkbox" /> Tools</label>
          <label><input type="checkbox" value="thinking" class="cap-checkbox" /> Thinking</label>
          <label><input type="checkbox" value="embedding" class="cap-checkbox" /> Embedding</label>
          <label><input type="checkbox" value="audio" class="cap-checkbox" /> Audio</label>
        </div>
      </div>

      <!-- Status Filter -->
      <div class="filter-group filter-group-checkboxes">
        <label>Status</label>
        <div class="checkbox-group">
          <label><input type="checkbox" id="filter-modified" /> User Modified</label>
          <label><input type="checkbox" id="filter-sync-enabled" /> Sync Enabled</label>
          <label><input type="checkbox" id="filter-sync-disabled" /> Sync Disabled</label>
        </div>
      </div>
    </div>

    <div class="filter-actions">
      <button class="btn-secondary" onclick="clearFilters()">Clear All</button>
      <span class="filter-separator"></span>
      <label class="toggle-label">
        <input type="checkbox" id="hide-orphaned" checked />
        <span>Hide Orphaned</span>
      </label>
    </div>
  </div>

  <!-- Results Summary -->
  <div class="results-summary">
    <span id="results-count">Loading...</span>
  </div>
  <div id="models-message" class="action-message"></div>

  <!-- Models List -->
  <div id="models-grid" class="models-list">
    Loading models...
  </div>
</section>

<!-- Model Detail Modal -->
<div id="model-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modal-title">Model Details</h2>
      <span class="modal-close" onclick="closeModal()">&times;</span>
    </div>
    <div id="model-action-message" class="action-message"></div>
    <div class="modal-body" id="modal-body">
      Loading...
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" onclick="closeModal()">Close</button>
    </div>
  </div>
</div>

<style>
.filters-panel {
  background: #242424;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 1.5rem;
  margin-bottom: 1.5rem;
}

.search-box {
  margin-bottom: 1rem;
}

.search-box input {
  width: 100%;
  padding: 0.75rem;
  font-size: 1rem;
  border: 2px solid #3a3a3a;
  border-radius: 8px;
  transition: border-color 0.2s;
  background: #1a1a1a;
  color: #e0e0e0;
}

.search-box input:focus {
  outline: none;
  border-color: #4a9eff;
  box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
}

.filters-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 1rem;
  margin-bottom: 1rem;
}

@media (max-width: 1200px) {
  .filters-grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (max-width: 768px) {
  .filters-grid {
    grid-template-columns: 1fr;
  }
}

.filter-group {
  display: flex;
  flex-direction: column;
}

.filter-group > label {
  display: block;
  font-weight: 600;
  margin-bottom: 0.4rem;
  color: #e0e0e0;
  font-size: 0.9rem;
}

.filter-group select {
  width: 100%;
  padding: 0.5rem;
  border: 1px solid #3a3a3a;
  border-radius: 4px;
  background: #1a1a1a;
  color: #e0e0e0;
  flex: 1;
}

.filter-group-checkboxes {
  display: flex;
  flex-direction: column;
}

.checkbox-group {
  display: flex;
  flex-direction: column;
  gap: 0.15rem;
  padding: 0.4rem 0.5rem;
  background: #1a1a1a;
  border: 1px solid #3a3a3a;
  border-radius: 4px;
  flex: 1;
  min-height: 0;
}

.checkbox-group label {
  display: flex;
  align-items: center;
  gap: 0.3rem;
  font-weight: 400;
  font-size: 0.8rem;
  cursor: pointer;
  margin-bottom: 0;
  line-height: 1.4;
}

.checkbox-group input[type="checkbox"] {
  cursor: pointer;
  width: 14px;
  height: 14px;
  margin: 0;
}

.filter-actions {
  display: flex;
  gap: 1rem;
  align-items: center;
  padding-top: 1rem;
  border-top: 1px solid #e0e0e0;
}

.results-summary {
  padding: 0.75rem 1rem;
  background: #1a2432;
  border-left: 3px solid #4a9eff;
  border-radius: 4px;
  margin-bottom: 1rem;
  font-weight: 500;
  color: #93c5fd;
}

.models-list {
  display: flex;
  flex-direction: column;
  gap: 0.5rem;
}

.model-card {
  background: #242424;
  border: 1px solid #333;
  border-radius: 8px;
  padding: 0.65rem 0.9rem;
  transition: all 0.2s;
  cursor: pointer;
  display: grid;
  grid-template-columns: minmax(240px, 2fr) minmax(220px, 3fr);
  align-items: center;
  gap: 0.75rem;
}

.model-card:hover {
  box-shadow: 0 4px 12px rgba(74, 158, 255, 0.2);
  transform: translateY(-2px);
  border-color: #4a9eff;
  background: #2a2a2a;
}

.model-card.orphaned {
  background: #2a1a1a;
  border-color: #ff6b6b;
  opacity: 0.7;
}

.model-main {
  display: flex;
  flex-direction: column;
  gap: 0.2rem;
  min-width: 0;
}

.model-name {
  font-weight: 700;
  font-size: 1rem;
  color: #4a9eff;
  line-height: 1.2;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.model-card.orphaned .model-name {
  color: #ff6b6b;
}

.model-category {
  font-size: 1.5rem;
  flex-shrink: 0;
}

.model-provider {
  color: #aaa;
  font-size: 0.85rem;
}

.model-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 0.35rem;
  margin-bottom: 0;
}

.capabilities-list {
  justify-content: flex-end;
}

.model-stats {
  display: flex;
  flex-wrap: wrap;
  justify-content: flex-end;
  gap: 0.35rem;
}
.meta-badge {
  display: inline-flex;
  align-items: center;
  padding: 0.25rem 0.5rem;
  background: #1a2432;
  border: 1px solid #2a3a52;
  border-radius: 12px;
  font-size: 0.75rem;
  color: #93c5fd;
  font-weight: 500;
}

.capabilities-list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.25rem;
  margin-top: 0.5rem;
}

.cap-badge {
  padding: 0.2rem 0.5rem;
  background: #102a1a;
  border: 1px solid #1a4428;
  border-radius: 8px;
  font-size: 0.7rem;
  color: #6ee7b7;
}

.btn-primary {
  background: #4a9eff;
  color: white;
  padding: 0.6rem 1.2rem;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.2s;
}

.btn-primary:hover {
  background: #3a8eef;
  transform: translateY(-1px);
}

.btn-secondary {
  background: #3a3a3a;
  color: white;
  padding: 0.6rem 1.2rem;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.2s;
}

.btn-secondary:hover {
  background: #4a4a4a;
  transform: translateY(-1px);
}

.toggle-label {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
}

.filter-separator {
  width: 1px;
  height: 24px;
  background: #ddd;
  margin: 0 0.5rem;
}

.action-message {
  display: none;
  margin: 0 1.5rem 1rem 1.5rem;
  padding: 0.75rem 1rem;
  border-radius: 6px;
  border: 1px solid transparent;
  font-size: 0.9rem;
}

.action-message.success {
  display: block;
  background: #102a1a;
  border-color: #1a4428;
  color: #6ee7b7;
}

.action-message.error {
  display: block;
  background: #2a1a1a;
  border-color: #4b1a1a;
  color: #fca5a5;
}

/* Modal Styles */
.modal {
  display: none;
  position: fixed;
  z-index: 1000;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  overflow: auto;
  background-color: rgba(0, 0, 0, 0.7);
}

.modal-content {
  background-color: #1a1a1a;
  margin: 2% auto;
  border-radius: 12px;
  width: 90%;
  max-width: 900px;
  max-height: 90vh;
  display: flex;
  flex-direction: column;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
  border: 1px solid #333;
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 1.5rem;
  border-bottom: 1px solid #2a2a2a;
}

.modal-header h2 {
  margin: 0;
  color: #4a9eff;
}

.modal-close {
  font-size: 2rem;
  font-weight: 300;
  color: #888;
  cursor: pointer;
  line-height: 1;
  transition: color 0.2s;
}

.modal-close:hover {
  color: #e0e0e0;
}

.modal-body {
  padding: 1.5rem;
  overflow-y: auto;
  flex: 1;
}

.modal-footer {
  padding: 1rem 1.5rem;
  border-top: 1px solid #2a2a2a;
  display: flex;
  justify-content: flex-end;
  gap: 0.5rem;
}

.detail-section {
  margin-bottom: 1.5rem;
}

.detail-section h3 {
  margin: 0 0 0.75rem 0;
  color: #fff;
  font-size: 1.1rem;
  border-bottom: 2px solid #4a9eff;
  padding-bottom: 0.5rem;
}

.detail-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
}

.detail-item {
  padding: 0.5rem;
  background: #242424;
  border-radius: 4px;
  border: 1px solid #333;
}

.detail-label {
  font-size: 0.85rem;
  color: #aaa;
  font-weight: 600;
  margin-bottom: 0.25rem;
}

.detail-value {
  font-size: 0.95rem;
  color: #e0e0e0;
  word-break: break-word;
}

.detail-value code {
  background: #102a1a;
  padding: 0.2rem 0.4rem;
  border-radius: 3px;
  font-size: 0.9rem;
  color: #6ee7b7;
}

.tags-list {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 0.5rem;
}

.tag-item {
  padding: 0.3rem 0.7rem;
  background: #1a2432;
  border: 1px solid #2a3a52;
  border-radius: 12px;
  font-size: 0.85rem;
  color: #93c5fd;
}

.json-viewer {
  background: #0f172a;
  border: 1px solid #2a2a2a;
  border-radius: 4px;
  padding: 1rem;
  font-family: 'Courier New', monospace;
  font-size: 0.85rem;
  overflow-x: auto;
  white-space: pre-wrap;
  word-break: break-all;
  color: #e2e8f0;
}

.capabilities-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 0.75rem;
  margin-top: 0.5rem;
}

.capability-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  border-radius: 8px;
  font-size: 0.9rem;
  font-weight: 500;
  transition: transform 0.2s, box-shadow 0.2s;
}

.capability-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
}

.capability-icon {
  font-size: 1.5rem;
  flex-shrink: 0;
}

.capability-name {
  flex: 1;
}

.action-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 0.75rem;
}

.action-field label {
  display: block;
  font-size: 0.85rem;
  font-weight: 600;
  color: #aaa;
  margin-bottom: 0.25rem;
}

.action-field input,
.action-field select {
  width: 100%;
  padding: 0.5rem;
  border-radius: 6px;
  border: 1px solid #3a3a3a;
  background: #1a1a1a;
  color: #e0e0e0;
}

.action-buttons {
  display: flex;
  gap: 0.5rem;
  margin-top: 0.75rem;
  flex-wrap: wrap;
}

.btn-danger {
  background: #ef4444;
  color: white;
  padding: 0.6rem 1.2rem;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: all 0.2s;
}

.btn-danger:hover {
  background: #dc2626;
  transform: translateY(-1px);
}
</style>

<script>
let allModels = [];
let filteredModels = [];
let providers = [];
let currentModel = null;

// Category icons
const categoryIcons = {
  chat: 'üí¨',
  vision: 'üëÅÔ∏è',
  code: 'üíª',
  reasoning: 'üß†',
  embedding: 'üî¢',
  audio: 'üé§',
  image: 'üé®',
  unknown: '‚ùì'
};

async function loadData() {
  try {
    // Load providers
    const providersResp = await fetch('/api/providers');
    providers = await providersResp.json();

    // Populate provider filter
    const providerSelect = document.getElementById('filter-provider');
    providers.forEach(p => {
      if (p.type !== 'compat' && p.type !== 'completion') {
        const option = document.createElement('option');
        option.value = p.id;
        option.textContent = p.name;
        providerSelect.appendChild(option);
      }
    });

    // Load all models from all providers
    allModels = [];
    for (const provider of providers) {
      if (provider.type === 'compat' || provider.type === 'completion') continue;

      const response = await fetch(`/api/providers/${provider.id}/models?include_orphaned=true`);
      const data = await response.json();
      const models = Array.isArray(data) ? data : (data.models || []);

      // Add provider info to each model
      models.forEach(m => {
        m.provider_name = provider.name;
        m.provider_id = provider.id;
      });

      allModels.push(...models);
    }

    // Get categories for each model
    await categorizeModels();

    // Apply URL filters if present
    applyUrlFilters();

    // Apply initial filters
    applyFilters();
  } catch (error) {
    document.getElementById('models-grid').innerHTML = `<p style="color: red;">Error loading models: ${error.message}</p>`;
  }
}

async function categorizeModels() {
  // Use the categorization endpoint to get categories
  for (const model of allModels) {
    // Simple categorization based on capabilities
    const caps = model.capabilities || [];
    const capsLower = caps.map(c => c.toLowerCase());

    if (capsLower.includes('vision')) {
      model.category = 'vision';
    } else if (capsLower.includes('embedding')) {
      model.category = 'embedding';
    } else if (capsLower.includes('audio')) {
      model.category = 'audio';
    } else if (capsLower.includes('thinking')) {
      model.category = 'reasoning';
    } else if (model.model_id.toLowerCase().includes('coder') || model.model_id.toLowerCase().includes('code')) {
      model.category = 'code';
    } else if (capsLower.some(c => ['chat', 'completion', 'tools', 'function calling'].includes(c))) {
      model.category = 'chat';
    } else {
      model.category = 'unknown';
    }
  }
}

function applyFilters() {
  const searchTerm = document.getElementById('search-input').value.toLowerCase();
  const selectedCategories = Array.from(document.getElementById('filter-category').selectedOptions).map(o => o.value).filter(v => v);
  const selectedProviders = Array.from(document.getElementById('filter-provider').selectedOptions).map(o => o.value).filter(v => v);
  const contextRange = document.getElementById('filter-context').value;
  const selectedCaps = Array.from(document.querySelectorAll('.cap-checkbox:checked')).map(cb => cb.value);
  const hideOrphaned = document.getElementById('hide-orphaned').checked;
  const filterModified = document.getElementById('filter-modified').checked;
  const filterSyncEnabled = document.getElementById('filter-sync-enabled').checked;
  const filterSyncDisabled = document.getElementById('filter-sync-disabled').checked;

  filteredModels = allModels.filter(model => {
    // Search filter
    if (searchTerm && !model.model_id.toLowerCase().includes(searchTerm)) {
      return false;
    }

    // Category filter
    if (selectedCategories.length > 0 && !selectedCategories.includes(model.category)) {
      return false;
    }

    // Provider filter
    if (selectedProviders.length > 0 && !selectedProviders.includes(String(model.provider_id))) {
      return false;
    }

    // Context window filter
    if (contextRange) {
      const [min, max] = contextRange.split('-').map(Number);
      const context = model.context_window || 0;
      if (context < min || context > max) {
        return false;
      }
    }

    // Capabilities filter
    if (selectedCaps.length > 0) {
      const modelCaps = (model.capabilities || []).map(c => c.toLowerCase());
      const hasAllCaps = selectedCaps.every(cap => modelCaps.includes(cap.toLowerCase()));
      if (!hasAllCaps) {
        return false;
      }
    }

    // Status filters
    if (filterModified && !model.user_modified) {
      return false;
    }
    if (filterSyncEnabled && !model.sync_enabled) {
      return false;
    }
    if (filterSyncDisabled && model.sync_enabled) {
      return false;
    }

    // Orphaned filter
    if (hideOrphaned && model.is_orphaned) {
      return false;
    }

    return true;
  });

  renderModels();
}

function renderModels() {
  const container = document.getElementById('models-grid');
  const resultsCount = document.getElementById('results-count');

  resultsCount.textContent = `Showing ${filteredModels.length} of ${allModels.length} models`;

  if (filteredModels.length === 0) {
    container.innerHTML = '<p class="muted">No models match your filters</p>';
    return;
  }

  const cards = filteredModels.map(model => {
    const icon = categoryIcons[model.category] || 'üì¶';
    const contextDisplay = model.context_window ? `${(model.context_window / 1024).toFixed(0)}K` : 'N/A';

    return `
      <div class="model-card ${model.is_orphaned ? 'orphaned' : ''}" onclick="showModelDetails(${model.id})">
        <div class="model-main">
          <div class="model-name" title="${model.display_name || model.model_id}">${model.display_name || model.model_id}</div>
          <div class="model-provider">${model.provider_name}</div>
        </div>

        <div class="model-stats">
          ${model.context_window ? `<span class="meta-badge">üìè ${contextDisplay} context</span>` : ''}
          ${model.is_orphaned ? `<span class="meta-badge" style="background: #2a1a1a; border-color: #4b1a1a; color: #fca5a5;">‚ö†Ô∏è Orphaned</span>` : ''}
          ${model.user_modified ? `<span class="meta-badge" style="background: #1a2432; border-color: #2a3a52; color: #93c5fd;">‚úèÔ∏è Modified</span>` : ''}
          ${model.capabilities && model.capabilities.length > 0 ? `
            ${model.capabilities.slice(0, 5).map(cap => `<span class="cap-badge">${cap}</span>`).join('')}
            ${model.capabilities.length > 5 ? `<span class="cap-badge">+${model.capabilities.length - 5}</span>` : ''}
          ` : ''}
        </div>
      </div>
    `;
  }).join('');

  container.innerHTML = cards;
}

function clearFilters() {
  document.getElementById('search-input').value = '';
  document.getElementById('filter-category').selectedIndex = -1;
  document.getElementById('filter-provider').selectedIndex = -1;
  document.getElementById('filter-context').selectedIndex = 0;
  document.querySelectorAll('.cap-checkbox').forEach(cb => cb.checked = false);
  document.getElementById('filter-modified').checked = false;
  document.getElementById('filter-sync-enabled').checked = false;
  document.getElementById('filter-sync-disabled').checked = false;
  document.getElementById('hide-orphaned').checked = true;
  applyFilters();
}

// Parse URL parameters and apply filters
function applyUrlFilters() {
  const urlParams = new URLSearchParams(window.location.search);

  // Apply category filter
  const category = urlParams.get('category');
  if (category) {
    const categorySelect = document.getElementById('filter-category');
    for (let option of categorySelect.options) {
      if (option.value === category) {
        option.selected = true;
        break;
      }
    }
  }

  // Apply provider filter
  const provider = urlParams.get('provider');
  if (provider) {
    const providerSelect = document.getElementById('filter-provider');
    for (let option of providerSelect.options) {
      if (option.value === provider) {
        option.selected = true;
        break;
      }
    }
  }

  // Apply search term
  const search = urlParams.get('search');
  if (search) {
    document.getElementById('search-input').value = search;
  }

  // Apply context window filter
  const context = urlParams.get('context');
  if (context) {
    document.getElementById('filter-context').value = context;
  }

  // Apply capabilities filter
  const capabilities = urlParams.get('capabilities');
  if (capabilities) {
    const caps = capabilities.split(',');
    document.querySelectorAll('.cap-checkbox').forEach(cb => {
      if (caps.includes(cb.value)) {
        cb.checked = true;
      }
    });
  }
}

// Helper function to get capability icon
function getCapabilityIcon(capability) {
  const cap = capability.toLowerCase();
  if (cap.includes('vision') || cap.includes('image')) return 'üëÅÔ∏è';
  if (cap.includes('audio') || cap.includes('speech')) return 'üé§';
  if (cap.includes('function') || cap.includes('tool')) return 'üîß';
  if (cap.includes('thinking') || cap.includes('reasoning')) return 'üß†';
  if (cap.includes('embedding')) return 'üî¢';
  if (cap.includes('chat') || cap.includes('completion')) return 'üí¨';
  if (cap.includes('code')) return 'üíª';
  return '‚ú®';
}

// Helper function to format pricing
function formatPricing(value) {
  if (!value) return 'N/A';
  const num = parseFloat(value);
  if (num === 0) return 'Free';
  if (num < 0.000001) return num.toExponential(2);
  if (num < 0.01) return `$${num.toFixed(6)}`;
  return `$${num.toFixed(4)}`;
}

function showMessage(targetId, message, type) {
  const el = document.getElementById(targetId);
  if (!el) return;
  el.textContent = message;
  el.classList.remove('success', 'error');
  if (type) {
    el.style.display = '';
    el.classList.add(type);
  } else {
    el.style.display = 'none';
  }
}

function showPageMessage(message, type) {
  showMessage('models-message', message, type);
}

function showModelMessage(message, type) {
  showMessage('model-action-message', message, type);
}

async function parseResponseError(response) {
  try {
    const data = await response.json();
    return data.detail || data.message || response.statusText;
  } catch (error) {
    return response.statusText;
  }
}

function updateLocalModel(modelId, updates) {
  const index = allModels.findIndex(m => m.id === modelId);
  if (index === -1) return;
  allModels[index] = { ...allModels[index], ...updates };
  applyFilters();
}

// Model details modal functions
async function showModelDetails(modelId) {
  const modal = document.getElementById('model-modal');
  const modalTitle = document.getElementById('modal-title');
  const modalBody = document.getElementById('modal-body');

  modal.style.display = 'block';
  modalBody.innerHTML = '<p>Loading model details...</p>';
  showModelMessage('', null);

  try {
    const response = await fetch(`/api/models/${modelId}`);
    if (!response.ok) throw new Error('Failed to load model details');

    const model = await response.json();
    currentModel = model;

    // Find provider info
    const provider = providers.find(p => p.id === model.provider_id);

    modalTitle.textContent = model.display_name || model.model_id;

    // Build detail sections
    let html = '';

    const effectiveParams = model.user_params || model.litellm_params || {};
    const modeValue = ['chat', 'completion'].includes(effectiveParams.mode) ? effectiveParams.mode : 'default';
    const inputOverride = model.pricing_override && model.pricing_override.input_cost_per_token !== undefined
      ? model.pricing_override.input_cost_per_token
      : '';
    const outputOverride = model.pricing_override && model.pricing_override.output_cost_per_token !== undefined
      ? model.pricing_override.output_cost_per_token
      : '';

    html += `
      <div class="detail-section">
        <h3>Actions</h3>
        <div class="action-grid">
          <div class="action-field">
            <label>Sync Enabled</label>
            <label class="toggle-label">
              <input type="checkbox" id="model-sync-enabled" ${model.sync_enabled ? 'checked' : ''} />
              <span>${model.sync_enabled ? 'Enabled' : 'Disabled'}</span>
            </label>
          </div>
          <div class="action-field">
            <label>Mode</label>
            <select id="model-mode">
              <option value="default" ${modeValue === 'default' ? 'selected' : ''}>Default</option>
              <option value="chat" ${modeValue === 'chat' ? 'selected' : ''}>Chat</option>
              <option value="completion" ${modeValue === 'completion' ? 'selected' : ''}>Completion</option>
            </select>
          </div>
          <div class="action-field">
            <label>Input $/token</label>
            <input type="number" id="model-input-price" step="0.000000001" placeholder="Leave blank to keep" value="${inputOverride}">
          </div>
          <div class="action-field">
            <label>Output $/token</label>
            <input type="number" id="model-output-price" step="0.000000001" placeholder="Leave blank to keep" value="${outputOverride}">
          </div>
        </div>
        <div class="action-buttons">
          <button class="btn-primary" type="button" onclick="saveModelEdits(${model.id})">Save Changes</button>
          <button class="btn-danger" type="button" onclick="deleteModel(${model.id})">Delete</button>
        </div>
      </div>
    `;

    html += `
      <div class="detail-section">
        <h3>Create Compat Alias</h3>
        <div class="action-grid">
          <div class="action-field">
            <label>Compat Name</label>
            <input type="text" id="compat-name" placeholder="gpt-4o, gpt-3.5-turbo">
          </div>
          <div class="action-field">
            <label>Compat Mode</label>
            <select id="compat-mode">
              <option value="chat">Chat</option>
              <option value="completion">Completion</option>
            </select>
          </div>
        </div>
        <div class="action-buttons">
          <button class="btn-secondary" type="button" onclick="createCompatFromModel(${model.id})">Create Compat</button>
        </div>
      </div>
    `;

    // Basic Information
    html += `
      <div class="detail-section">
        <h3>Basic Information</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <div class="detail-label">Model ID</div>
            <div class="detail-value"><code>${model.model_id}</code></div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Display Name</div>
            <div class="detail-value">${model.display_name || model.model_id}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Provider</div>
            <div class="detail-value">${provider ? provider.name : 'Unknown'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Category</div>
            <div class="detail-value">${categoryIcons[model.category] || 'üì¶'} ${model.category ? model.category.charAt(0).toUpperCase() + model.category.slice(1) : 'Unknown'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Status</div>
            <div class="detail-value">
              ${model.is_orphaned ? '<span style="color: #d32f2f;">‚ö†Ô∏è Orphaned</span>' : '<span style="color: #2e7d32;">‚úì Active</span>'}
            </div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Sync Enabled</div>
            <div class="detail-value">${model.sync_enabled ? '‚úì Yes' : '‚úó No'}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">User Modified</div>
            <div class="detail-value">${model.user_modified ? '‚úì Yes' : '‚úó No'}</div>
          </div>
        </div>
      </div>
    `;

    // Model Specifications
    html += `
      <div class="detail-section">
        <h3>Model Specifications</h3>
        <div class="detail-grid">
          ${model.context_window ? `
            <div class="detail-item">
              <div class="detail-label">Context Window</div>
              <div class="detail-value">${(model.context_window).toLocaleString()} tokens</div>
            </div>
          ` : ''}
          ${model.max_input_tokens ? `
            <div class="detail-item">
              <div class="detail-label">Max Input Tokens</div>
              <div class="detail-value">${(model.max_input_tokens).toLocaleString()}</div>
            </div>
          ` : ''}
          ${model.max_output_tokens ? `
            <div class="detail-item">
              <div class="detail-label">Max Output Tokens</div>
              <div class="detail-value">${(model.max_output_tokens).toLocaleString()}</div>
            </div>
          ` : ''}
          ${model.max_tokens ? `
            <div class="detail-item">
              <div class="detail-label">Max Tokens</div>
              <div class="detail-value">${(model.max_tokens).toLocaleString()}</div>
            </div>
          ` : ''}
        </div>
      </div>
    `;

    // Capabilities
    if (model.capabilities && model.capabilities.length > 0) {
      html += `
        <div class="detail-section">
          <h3>Capabilities</h3>
          <div class="capabilities-grid">
            ${model.capabilities.map(cap => `
              <div class="capability-item">
                <span class="capability-icon">${getCapabilityIcon(cap)}</span>
                <span class="capability-name">${cap}</span>
              </div>
            `).join('')}
          </div>
        </div>
      `;
    }

    // Tags
    if (model.user_tags && model.user_tags.length > 0) {
      html += `
        <div class="detail-section">
          <h3>User Tags</h3>
          <div class="tags-list">
            ${model.user_tags.map(tag => `<span class="tag-item">${tag}</span>`).join('')}
          </div>
        </div>
      `;
    }

    // Pricing
    const hasInputPrice = effectiveParams.input_cost_per_token !== undefined;
    const hasOutputPrice = effectiveParams.output_cost_per_token !== undefined;
    const hasPricing = hasInputPrice || hasOutputPrice || model.pricing_profile;

    if (hasPricing) {
      html += `
        <div class="detail-section">
          <h3>Pricing</h3>
          <div class="detail-grid">
            ${model.pricing_profile ? `
              <div class="detail-item">
                <div class="detail-label">Pricing Profile</div>
                <div class="detail-value">${model.pricing_profile}</div>
              </div>
            ` : ''}
            ${hasInputPrice ? `
              <div class="detail-item">
                <div class="detail-label">Input Cost per Token ${model.pricing_override ? '(Custom)' : '(Inherited)'}</div>
                <div class="detail-value">${formatPricing(effectiveParams.input_cost_per_token)}</div>
              </div>
            ` : ''}
            ${hasOutputPrice ? `
              <div class="detail-item">
                <div class="detail-label">Output Cost per Token ${model.pricing_override ? '(Custom)' : '(Inherited)'}</div>
                <div class="detail-value">${formatPricing(effectiveParams.output_cost_per_token)}</div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    // Timestamps
    const formatDate = (dateStr) => {
      if (!dateStr) return 'Never';
      const date = new Date(dateStr);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      let relative = '';
      if (diffMins < 1) relative = 'just now';
      else if (diffMins < 60) relative = `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
      else if (diffHours < 24) relative = `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
      else if (diffDays < 7) relative = `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
      else relative = date.toLocaleDateString();

      return `${relative}<br><span style="font-size: 0.85em; color: #999;">${date.toLocaleString()}</span>`;
    };

    html += `
      <div class="detail-section">
        <h3>Model History</h3>
        <div class="detail-grid">
          <div class="detail-item">
            <div class="detail-label">First Seen</div>
            <div class="detail-value">${formatDate(model.first_seen)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Last Seen</div>
            <div class="detail-value">${formatDate(model.last_seen)}</div>
          </div>
          ${model.is_orphaned && model.orphaned_at ? `
            <div class="detail-item">
              <div class="detail-label">Orphaned Since</div>
              <div class="detail-value" style="color: #d32f2f;">${formatDate(model.orphaned_at)}</div>
            </div>
          ` : ''}
          <div class="detail-item">
            <div class="detail-label">Created</div>
            <div class="detail-value">${formatDate(model.created_at)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Last Updated</div>
            <div class="detail-value">${formatDate(model.updated_at)}</div>
          </div>
        </div>
      </div>
    `;

    // LiteLLM Parameters (collapsed by default)
    if (model.litellm_params) {
      html += `
        <div class="detail-section">
          <h3>LiteLLM Parameters</h3>
          <div class="json-viewer">${JSON.stringify(model.litellm_params, null, 2)}</div>
        </div>
      `;
    }

    // User Parameters (if set)
    if (model.user_params) {
      html += `
        <div class="detail-section">
          <h3>User Parameters (Override)</h3>
          <div class="json-viewer">${JSON.stringify(model.user_params, null, 2)}</div>
        </div>
      `;
    }

    modalBody.innerHTML = html;
  } catch (error) {
    modalBody.innerHTML = `<p style="color: red;">Error loading model details: ${error.message}</p>`;
  }
}

function closeModal() {
  document.getElementById('model-modal').style.display = 'none';
  showModelMessage('', null);
}

async function saveModelEdits(modelId) {
  const syncEnabled = document.getElementById('model-sync-enabled').checked;
  const mode = document.getElementById('model-mode').value;
  const inputCost = document.getElementById('model-input-price').value;
  const outputCost = document.getElementById('model-output-price').value;

  const payload = { sync_enabled: syncEnabled, mode };
  if (inputCost !== '') payload.input_cost_per_token = inputCost;
  if (outputCost !== '') payload.output_cost_per_token = outputCost;

  try {
    const response = await fetch(`/api/models/${modelId}/params`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) {
      const errorMessage = await parseResponseError(response);
      showModelMessage(`Error saving model: ${errorMessage}`, 'error');
      return;
    }

    updateLocalModel(modelId, { sync_enabled: syncEnabled, user_modified: true });
    showModelMessage('Model updated successfully.', 'success');
  } catch (error) {
    showModelMessage(`Error saving model: ${error.message}`, 'error');
  }
}

async function deleteModel(modelId) {
  if (!confirm('Are you sure you want to delete this model?')) {
    return;
  }

  try {
    const response = await fetch(`/api/models/${modelId}`, { method: 'DELETE' });
    if (!response.ok) {
      const errorMessage = await parseResponseError(response);
      showModelMessage(`Error deleting model: ${errorMessage}`, 'error');
      return;
    }

    allModels = allModels.filter(m => m.id !== modelId);
    applyFilters();
    closeModal();
    showPageMessage('Model deleted successfully.', 'success');
  } catch (error) {
    showModelMessage(`Error deleting model: ${error.message}`, 'error');
  }
}

async function createCompatFromModel(modelId) {
  const compatName = document.getElementById('compat-name').value.trim();
  const compatMode = document.getElementById('compat-mode').value;

  if (!compatName) {
    showModelMessage('Compat name is required.', 'error');
    return;
  }

  if (!currentModel) {
    showModelMessage('Model data not loaded.', 'error');
    return;
  }

  try {
    const formData = new FormData();
    formData.append('model_name', compatName);
    formData.append('mapped_provider_id', String(currentModel.provider_id));
    formData.append('mapped_model_id', currentModel.model_id);
    formData.append('mode', compatMode);

    const response = await fetch('/api/compat/models', {
      method: 'POST',
      body: formData
    });

    if (!response.ok) {
      const errorMessage = await parseResponseError(response);
      showModelMessage(`Error creating compat: ${errorMessage}`, 'error');
      return;
    }

    showModelMessage(`Compat model "${compatName}" created.`, 'success');
    document.getElementById('compat-name').value = '';
  } catch (error) {
    showModelMessage(`Error creating compat: ${error.message}`, 'error');
  }
}

// Close modal when clicking outside of it
window.onclick = function(event) {
  const modal = document.getElementById('model-modal');
  if (event.target === modal) {
    closeModal();
  }
}

// Real-time search and auto-apply filters
document.addEventListener('DOMContentLoaded', () => {
  loadData();

  // Auto-apply on search input
  document.getElementById('search-input').addEventListener('input', () => {
    applyFilters();
  });

  // Auto-apply on select changes
  document.getElementById('filter-category').addEventListener('change', () => {
    applyFilters();
  });

  document.getElementById('filter-provider').addEventListener('change', () => {
    applyFilters();
  });

  document.getElementById('filter-context').addEventListener('change', () => {
    applyFilters();
  });

  // Auto-apply on checkbox changes
  document.getElementById('hide-orphaned').addEventListener('change', () => {
    applyFilters();
  });

  document.getElementById('filter-modified').addEventListener('change', () => {
    applyFilters();
  });

  document.getElementById('filter-sync-enabled').addEventListener('change', () => {
    applyFilters();
  });

  document.getElementById('filter-sync-disabled').addEventListener('change', () => {
    applyFilters();
  });

  // Auto-apply on capability checkbox changes
  document.querySelectorAll('.cap-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', () => {
      applyFilters();
    });
  });
});
</script>

{% endblock %}
